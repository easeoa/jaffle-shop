models:
  - name: customers
    description: 顧客概要データマート。各顧客の主要な詳細情報を提供します。顧客1人につき1行です。
    data_tests:
      - dbt_utils.expression_is_true:
          expression: "lifetime_spend_pretax + lifetime_tax_paid = lifetime_spend"
    columns:
      - name: customer_id
        description: 顧客マートのユニークキーです。
        data_tests:
          - not_null
          - unique
        meta:
          metrics:
            customer_counts:
              label: ユニーク顧客数
              type: count_distinct
              sql: ${TABLE}.customer_id
      - name: customer_name
        description: 顧客のフルネームです。
      - name: count_lifetime_orders
        description: 顧客がこれまでに注文した注文の総数です。
      - name: first_ordered_at
        description: 顧客が最初の注文を行ったタイムスタンプです。
      - name: last_ordered_at
        description: 顧客の最新の注文のタイムスタンプです。
      - name: lifetime_spend_pretax
        description: 顧客が行ったすべての注文の税抜き小計の合計です。
      - name: lifetime_tax_paid
        description: 顧客が行ったすべての注文の税額部分の合計です。
      - name: lifetime_spend
        description: 顧客がこれまでに行ったすべての注文の合計金額（税込）です。
      - name: customer_type
        description: オプションは「new」または「returning」で、顧客が複数回注文しているか、初回注文のみかを示します。
        data_tests:
          - accepted_values:
              values: ["new", "returning"]
    meta:
      metrics:
        average_order_value:
          label: 平均注文単価
          type: number
          sql: ${TABLE}.lifetime_spend_pretax / nullif(${TABLE}.count_lifetime_orders, 0)