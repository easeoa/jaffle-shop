models:
  - name: orders
    description: 注文概要データマート。各注文の主要な詳細情報を提供し、顧客の初回注文かどうか、食品とドリンクの内訳を含みます。注文1つにつき1行です。
    data_tests:
      - dbt_utils.expression_is_true:
          expression: "order_items_subtotal = subtotal"
      - dbt_utils.expression_is_true:
          expression: "order_total = subtotal + tax_paid"
    columns:
      - name: order_id
        description: 注文マートのユニークキー
        data_tests:
          - not_null
          - unique
      - name: customer_id
        description: 注文を行った顧客を参照する外部キー
        data_tests:
          - relationships:
              to: ref('stg_customers')
              field: customer_id
      - name: order_total
        description: 税込の注文総額（USD）
      - name: ordered_at
        description: 注文が行われたタイムスタンプ
      - name: order_cost
        description: 注文を履行するための供給費の合計
      - name: is_food_order
        description: この注文に食品アイテムが含まれているかを示すブール値
      - name: is_drink_order
        description: この注文にドリンクアイテムが含まれているかを示すブール値
      - name: customer_order_number
        description: 顧客の注文番号（初回注文は1）
    meta:
      metrics:
        order_count:
          label: 注文数
          type: count_distinct
          sql: ${TABLE}.order_id
        total_order_amount:
          label: 注文総額
          type: sum
          sql: ${TABLE}.order_total
        total_order_cost:
          label: 注文コスト
          type: sum
          sql: ${TABLE}.order_cost
        new_customer_orders:
          label: 新規顧客注文数
          type: count_distinct
          sql: case when ${TABLE}.customer_order_number = 1 then ${TABLE}.order_id else null end
        large_orders:
          label: 大口注文数
          type: count_distinct
          sql: case when ${TABLE}.order_total >= 20 then ${TABLE}.order_id else null end
        food_orders:
          label: 食品注文数
          type: count_distinct
          sql: case when ${TABLE}.is_food_order then ${TABLE}.order_id else null end
        drink_orders:
          label: ドリンク注文数
          type: count_distinct
          sql: case when ${TABLE}.is_drink_order then ${TABLE}.order_id else null end
